# ğŸ”„ Azure Service Bus ile Saga Orchestration

Bu dokÃ¼mantasyon, **Azure Service Bus** kullanarak **Saga Orchestration** pattern'inin nasÄ±l uygulanacaÄŸÄ±nÄ± detaylÄ± olarak aÃ§Ä±klar.

---

## ğŸ“‹ Ä°Ã§indekiler

1. [Saga Orchestration Nedir?](#saga-orchestration-nedir)
2. [Azure Service Bus Temelleri](#azure-service-bus-temelleri)
3. [Mimari Diyagramlar](#mimari-diyagramlar)
4. [SipariÅŸ Saga Ã–rneÄŸi](#sipariÅŸ-saga-Ã¶rneÄŸi)
5. [Implementasyon](#implementasyon)
6. [Docker Compose YapÄ±landÄ±rmasÄ±](#docker-compose-yapÄ±landÄ±rmasÄ±)
7. [Test ve DoÄŸrulama](#test-ve-doÄŸrulama)

---

## Saga Orchestration Nedir?

### Problem

Mikroservis mimarisinde her servis kendi veritabanÄ±na sahiptir. Birden fazla servisi kapsayan bir iÅŸlem yapÄ±ldÄ±ÄŸÄ±nda, geleneksel ACID transaction kullanÄ±lamaz.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           PROBLEM: DaÄŸÄ±tÄ±k Transaction                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚   â”‚  Customer DB    â”‚    â”‚   Order DB      â”‚    â”‚  Product DB     â”‚            â”‚
â”‚   â”‚  (SQL Server)   â”‚    â”‚  (CosmosDB)     â”‚    â”‚  (SQL Server)   â”‚            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚            â”‚                      â”‚                      â”‚                      â”‚
â”‚            â”‚                      â”‚                      â”‚                      â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚                                   â”‚                                              â”‚
â”‚                                   â–¼                                              â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                    â”‚                              â”‚                             â”‚
â”‚                    â”‚   âŒ Tek Transaction ile     â”‚                             â”‚
â”‚                    â”‚      yÃ¶netilemez!            â”‚                             â”‚
â”‚                    â”‚                              â”‚                             â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Ã‡Ã¶zÃ¼m: Saga Pattern

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            Ã‡Ã–ZÃœM: Saga Pattern                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   Saga = Yerel transaction'larÄ±n sÄ±rasÄ± + Compensation (geri alma) mekanizmasÄ±  â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚   â”‚  T1     â”‚ â”€â”€â”€â–¶ â”‚  T2     â”‚ â”€â”€â”€â–¶ â”‚  T3     â”‚ â”€â”€â”€â–¶ â”‚  T4     â”‚               â”‚
â”‚   â”‚Customer â”‚      â”‚ Order   â”‚      â”‚ Product â”‚      â”‚ Payment â”‚               â”‚
â”‚   â”‚Validate â”‚      â”‚ Create  â”‚      â”‚ Reserve â”‚      â”‚ Process â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜               â”‚
â”‚        â”‚                â”‚                â”‚                â”‚                     â”‚
â”‚        â”‚                â”‚                â”‚                â”‚                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”               â”‚
â”‚   â”‚  C1     â”‚ â—€â”€â”€â”€ â”‚  C2     â”‚ â—€â”€â”€â”€ â”‚  C3     â”‚ â—€â”€â”€â”€ â”‚  C4     â”‚               â”‚
â”‚   â”‚  (yok)  â”‚      â”‚ Cancel  â”‚      â”‚ Release â”‚      â”‚ Refund  â”‚               â”‚
â”‚   â”‚         â”‚      â”‚ Order   â”‚      â”‚ Stock   â”‚      â”‚         â”‚               â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                                  â”‚
â”‚   T = Transaction    C = Compensation (Geri Alma)                               â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Orchestration vs Choreography

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                                  â”‚
â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚   â•‘                        CHOREOGRAPHY                                       â•‘ â”‚
â”‚   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚   â•‘                                                                           â•‘ â”‚
â”‚   â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  event   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  event   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â•‘ â”‚
â”‚   â•‘    â”‚Service Aâ”‚ â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚Service Bâ”‚ â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚Service Câ”‚                 â•‘ â”‚
â”‚   â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â•‘ â”‚
â”‚   â•‘                                                                           â•‘ â”‚
â”‚   â•‘    â€¢ Merkezi kontrol yok                                                  â•‘ â”‚
â”‚   â•‘    â€¢ Servisler birbirini event ile tetikler                              â•‘ â”‚
â”‚   â•‘    â€¢ Takip ve debug zor                                                   â•‘ â”‚
â”‚   â•‘    â€¢ DÃ¶ngÃ¼sel baÄŸÄ±mlÄ±lÄ±k riski                                           â•‘ â”‚
â”‚   â•‘                                                                           â•‘ â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                                  â”‚
â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚
â”‚   â•‘                        ORCHESTRATION âœ“                                    â•‘ â”‚
â”‚   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£ â”‚
â”‚   â•‘                                                                           â•‘ â”‚
â”‚   â•‘                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                â•‘ â”‚
â”‚   â•‘                    â”‚   SAGA ORCHESTRATOR â”‚                                â•‘ â”‚
â”‚   â•‘                    â”‚   (Merkezi Kontrol) â”‚                                â•‘ â”‚
â”‚   â•‘                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                â•‘ â”‚
â”‚   â•‘                               â”‚                                           â•‘ â”‚
â”‚   â•‘           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â•‘ â”‚
â”‚   â•‘           â”‚                   â”‚                   â”‚                       â•‘ â”‚
â”‚   â•‘           â–¼                   â–¼                   â–¼                       â•‘ â”‚
â”‚   â•‘    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â•‘ â”‚
â”‚   â•‘    â”‚Service Aâ”‚         â”‚Service Bâ”‚         â”‚Service Câ”‚                   â•‘ â”‚
â”‚   â•‘    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â•‘ â”‚
â”‚   â•‘                                                                           â•‘ â”‚
â”‚   â•‘    â€¢ Merkezi orkestratÃ¶r                                                  â•‘ â”‚
â”‚   â•‘    â€¢ Kolay takip ve debug                                                 â•‘ â”‚
â”‚   â•‘    â€¢ Daha az baÄŸÄ±mlÄ±lÄ±k                                                   â•‘ â”‚
â”‚   â•‘    â€¢ State yÃ¶netimi kolay                                                 â•‘ â”‚
â”‚   â•‘                                                                           â•‘ â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Azure Service Bus Temelleri

### Queue vs Topic

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         AZURE SERVICE BUS KAVRAMLARI                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚   â•‘                              QUEUE                                      â•‘   â”‚
â”‚   â•‘                     (Bire-bir mesaj iletimi)                            â•‘   â”‚
â”‚   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â”‚
â”‚   â•‘                                                                         â•‘   â”‚
â”‚   â•‘    Producer â”€â”€â”€â–¶ [â•â•â• Queue â•â•â•] â”€â”€â”€â–¶ Consumer                         â•‘   â”‚
â”‚   â•‘                                                                         â•‘   â”‚
â”‚   â•‘    â€¢ Bir mesaj sadece bir consumer tarafÄ±ndan iÅŸlenir                   â•‘   â”‚
â”‚   â•‘    â€¢ Point-to-point iletiÅŸim                                            â•‘   â”‚
â”‚   â•‘    â€¢ Command pattern iÃ§in ideal                                         â•‘   â”‚
â”‚   â•‘                                                                         â•‘   â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                  â”‚
â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—   â”‚
â”‚   â•‘                              TOPIC                                      â•‘   â”‚
â”‚   â•‘                  (Birden-Ã§oka mesaj iletimi)                            â•‘   â”‚
â”‚   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£   â”‚
â”‚   â•‘                                                                         â•‘   â”‚
â”‚   â•‘                           â”Œâ”€â”€â–¶ Subscription A â”€â”€â–¶ Consumer 1            â•‘   â”‚
â”‚   â•‘                           â”‚                                             â•‘   â”‚
â”‚   â•‘    Publisher â”€â”€â”€â–¶ Topic â”€â”€â”¼â”€â”€â–¶ Subscription B â”€â”€â–¶ Consumer 2            â•‘   â”‚
â”‚   â•‘                           â”‚                                             â•‘   â”‚
â”‚   â•‘                           â””â”€â”€â–¶ Subscription C â”€â”€â–¶ Consumer 3            â•‘   â”‚
â”‚   â•‘                                                                         â•‘   â”‚
â”‚   â•‘    â€¢ Bir mesaj birden fazla consumer'a iletilebilir                     â•‘   â”‚
â”‚   â•‘    â€¢ Pub/Sub pattern                                                    â•‘   â”‚
â”‚   â•‘    â€¢ Event pattern iÃ§in ideal                                           â•‘   â”‚
â”‚   â•‘                                                                         â•‘   â”‚
â”‚   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Saga iÃ§in Service Bus KullanÄ±mÄ±

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     SAGA Ä°Ã‡Ä°N SERVICE BUS YAPILANDIRMASI                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         COMMAND QUEUES                                  â”‚   â”‚
â”‚   â”‚                   (OrkestratÃ¶r â†’ Servisler)                             â”‚   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â”‚   validate-customer-queue     â”€â”€â”€â–¶  Customer Service                    â”‚   â”‚
â”‚   â”‚   create-order-queue          â”€â”€â”€â–¶  Order Service                       â”‚   â”‚
â”‚   â”‚   reserve-stock-queue         â”€â”€â”€â–¶  Product Service                     â”‚   â”‚
â”‚   â”‚   process-payment-queue       â”€â”€â”€â–¶  Payment Service                     â”‚   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â”‚   cancel-order-queue          â”€â”€â”€â–¶  Order Service (Compensation)        â”‚   â”‚
â”‚   â”‚   release-stock-queue         â”€â”€â”€â–¶  Product Service (Compensation)      â”‚   â”‚
â”‚   â”‚   refund-payment-queue        â”€â”€â”€â–¶  Payment Service (Compensation)      â”‚   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         REPLY QUEUES                                    â”‚   â”‚
â”‚   â”‚                   (Servisler â†’ OrkestratÃ¶r)                             â”‚   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â”‚   saga-reply-queue            â—€â”€â”€â”€  TÃ¼m servislerden yanÄ±t             â”‚   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                         EVENT TOPICS                                    â”‚   â”‚
â”‚   â”‚                   (Servisler â†’ Notification)                            â”‚   â”‚
â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â”‚   saga-events-topic                                                     â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ saga-completed-subscription  â”€â”€â”€â–¶  Notification Service          â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ saga-failed-subscription     â”€â”€â”€â–¶  Notification Service          â”‚   â”‚
â”‚   â”‚   â””â”€â”€ audit-subscription           â”€â”€â”€â–¶  Audit Service                  â”‚   â”‚
â”‚   â”‚                                                                         â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Mimari Diyagramlar

### Genel Sistem Mimarisi

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              SAGA ORCHESTRATION MÄ°MARÄ°SÄ°                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                          â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚                                    â”‚    API Gateway      â”‚                              â”‚
â”‚                                    â”‚      (YARP)         â”‚                              â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                               â”‚                                          â”‚
â”‚                                               â”‚ HTTP Request                             â”‚
â”‚                                               â–¼                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                                                                                â”‚   â”‚
â”‚   â”‚                           â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—                        â”‚   â”‚
â”‚   â”‚                           â•‘    SAGA ORCHESTRATOR      â•‘                        â”‚   â”‚
â”‚   â”‚                           â•‘    (Azure Function)       â•‘                        â”‚   â”‚
â”‚   â”‚                           â•‘                           â•‘                        â”‚   â”‚
â”‚   â”‚                           â•‘  â€¢ State Machine          â•‘                        â”‚   â”‚
â”‚   â”‚                           â•‘  â€¢ Saga Coordinator       â•‘                        â”‚   â”‚
â”‚   â”‚                           â•‘  â€¢ Retry/Timeout Handler  â•‘                        â”‚   â”‚
â”‚   â”‚                           â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â•â•â•                        â”‚   â”‚
â”‚   â”‚                                           â”‚                                    â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                               â”‚                                          â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                    â”‚                          â”‚                          â”‚              â”‚
â”‚                    â–¼                          â–¼                          â–¼              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚   â”‚                         â”‚  â”‚                         â”‚  â”‚                         â”‚â”‚
â”‚   â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚  â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚  â”‚   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•— â”‚â”‚
â”‚   â”‚   â•‘  COMMAND QUEUE    â•‘ â”‚  â”‚   â•‘  COMMAND QUEUE    â•‘ â”‚  â”‚   â•‘  COMMAND QUEUE    â•‘ â”‚â”‚
â”‚   â”‚   â•šâ•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â• â”‚  â”‚   â•šâ•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â• â”‚  â”‚   â•šâ•â•â•â•â•â•â•â•â•â•¤â•â•â•â•â•â•â•â•â•â• â”‚â”‚
â”‚   â”‚             â”‚           â”‚  â”‚             â”‚           â”‚  â”‚             â”‚           â”‚â”‚
â”‚   â”‚             â–¼           â”‚  â”‚             â–¼           â”‚  â”‚             â–¼           â”‚â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚   â”‚   â”‚                 â”‚   â”‚  â”‚   â”‚                 â”‚   â”‚  â”‚   â”‚                 â”‚   â”‚â”‚
â”‚   â”‚   â”‚    Customer     â”‚   â”‚  â”‚   â”‚     Order       â”‚   â”‚  â”‚   â”‚    Product      â”‚   â”‚â”‚
â”‚   â”‚   â”‚    Service      â”‚   â”‚  â”‚   â”‚    Service      â”‚   â”‚  â”‚   â”‚    Service      â”‚   â”‚â”‚
â”‚   â”‚   â”‚                 â”‚   â”‚  â”‚   â”‚                 â”‚   â”‚  â”‚   â”‚                 â”‚   â”‚â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚   â”‚            â”‚            â”‚  â”‚            â”‚            â”‚  â”‚            â”‚            â”‚â”‚
â”‚   â”‚            â–¼            â”‚  â”‚            â–¼            â”‚  â”‚            â–¼            â”‚â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚â”‚
â”‚   â”‚   â”‚   SQL Server    â”‚   â”‚  â”‚   â”‚   CosmosDB      â”‚   â”‚  â”‚   â”‚   SQL Server    â”‚   â”‚â”‚
â”‚   â”‚   â”‚   CustomerDb    â”‚   â”‚  â”‚   â”‚   OrderDb       â”‚   â”‚  â”‚   â”‚   ProductDb     â”‚   â”‚â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚â”‚
â”‚   â”‚                         â”‚  â”‚                         â”‚  â”‚                         â”‚â”‚
â”‚   â”‚   Azure Service Bus     â”‚  â”‚   Azure Service Bus     â”‚  â”‚   Azure Service Bus     â”‚â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                            NOTIFICATION SERVICE                                 â”‚   â”‚
â”‚   â”‚                           (Azure Function)                                      â”‚   â”‚
â”‚   â”‚                                                                                 â”‚   â”‚
â”‚   â”‚    saga-events-topic  â”€â”€â”€â–¶  ğŸ“§ Email  â”‚  ğŸ“± SMS  â”‚  ğŸ”” Push                    â”‚   â”‚
â”‚   â”‚                                                                                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Saga State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                SAGA STATE MACHINE                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                          â”‚
â”‚                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚                                 â”‚   CREATED    â”‚                                        â”‚
â”‚                                 â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                        â”‚                                                 â”‚
â”‚                                        â”‚ StartSaga()                                     â”‚
â”‚                                        â–¼                                                 â”‚
â”‚                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”‚  VALIDATING  â”‚â”€â”€â”€â”€â”€â”€â”€â”                                â”‚
â”‚                         â”‚       â”‚   CUSTOMER   â”‚       â”‚                                â”‚
â”‚                         â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚                                â”‚
â”‚                         â”‚                              â”‚                                 â”‚
â”‚              CustomerValid                    CustomerInvalid                            â”‚
â”‚                         â”‚                              â”‚                                 â”‚
â”‚                         â–¼                              â”‚                                 â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚                                 â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”‚   CREATING   â”‚â”€â”€â”€â”€â”€â”€â”€â”              â”‚                                 â”‚
â”‚          â”‚       â”‚    ORDER     â”‚       â”‚              â”‚                                 â”‚
â”‚          â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚              â”‚                                 â”‚
â”‚          â”‚                              â”‚              â”‚                                 â”‚
â”‚     OrderCreated                   OrderFailed         â”‚                                 â”‚
â”‚          â”‚                              â”‚              â”‚                                 â”‚
â”‚          â–¼                              â”‚              â”‚                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚              â”‚                                 â”‚
â”‚   â”‚  RESERVING   â”‚â”€â”€â”€â”€â”€â”€â”€â”              â”‚              â”‚                                 â”‚
â”‚   â”‚    STOCK     â”‚       â”‚              â”‚              â”‚                                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚              â”‚              â”‚                                 â”‚
â”‚          â”‚               â”‚              â”‚              â”‚                                 â”‚
â”‚  StockReserved     OutOfStock           â”‚              â”‚                                 â”‚
â”‚          â”‚               â”‚              â”‚              â”‚                                 â”‚
â”‚          â–¼               â”‚              â”‚              â”‚                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚              â”‚              â”‚                                 â”‚
â”‚   â”‚  PROCESSING  â”‚â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                 â”‚
â”‚   â”‚   PAYMENT    â”‚       â”‚              â”‚              â”‚                                 â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚              â”‚              â”‚                                 â”‚
â”‚          â”‚               â”‚              â”‚              â”‚                                 â”‚
â”‚  PaymentSuccess     PaymentFailed       â”‚              â”‚                                 â”‚
â”‚          â”‚               â”‚              â”‚              â”‚                                 â”‚
â”‚          â–¼               â–¼              â–¼              â–¼                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚   â”‚              â”‚   â”‚                                      â”‚                           â”‚
â”‚   â”‚  COMPLETED   â”‚   â”‚            COMPENSATING              â”‚                           â”‚
â”‚   â”‚      âœ“       â”‚   â”‚                                      â”‚                           â”‚
â”‚   â”‚              â”‚   â”‚   C4 â† C3 â† C2 â† C1 (geri al)       â”‚                           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                                      â”‚                           â”‚
â”‚          â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚          â”‚                            â”‚                                                  â”‚
â”‚          â”‚                            â”‚ CompensationDone                                 â”‚
â”‚          â”‚                            â–¼                                                  â”‚
â”‚          â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                         â”‚
â”‚          â”‚                     â”‚    FAILED    â”‚                                         â”‚
â”‚          â”‚                     â”‚      âœ—       â”‚                                         â”‚
â”‚          â”‚                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                         â”‚
â”‚          â”‚                            â”‚                                                  â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚                                       â”‚                                                  â”‚
â”‚                                       â–¼                                                  â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚                         â”‚                           â”‚                                   â”‚
â”‚                         â”‚   NOTIFICATION SERVICE    â”‚                                   â”‚
â”‚                         â”‚                           â”‚                                   â”‚
â”‚                         â”‚  âœ“ Completed â†’ Onay mail  â”‚                                   â”‚
â”‚                         â”‚  âœ— Failed â†’ Hata mail     â”‚                                   â”‚
â”‚                         â”‚                           â”‚                                   â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### SipariÅŸ OluÅŸturma AkÄ±ÅŸÄ± (DetaylÄ±)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          SÄ°PARÄ°Å OLUÅTURMA SAGA AKIÅI                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                          â”‚
â”‚  Client          Gateway        Orchestrator      Customer       Order        Product   â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚ POST /orders   â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚ StartOrderSaga â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—      â”‚
â”‚    â”‚                â”‚                â”‚ â•‘ STEP 1: Validate Customer              â•‘      â”‚
â”‚    â”‚                â”‚                â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•      â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚â”€â”€ValidateCmdâ”€â–¶â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚â—€â”€CustomerOKâ”€â”€â”€â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—      â”‚
â”‚    â”‚                â”‚                â”‚ â•‘ STEP 2: Create Order                   â•‘      â”‚
â”‚    â”‚                â”‚                â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•      â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚â”€â”€â”€â”€â”€CreateOrderCmdâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚â—€â”€â”€â”€â”€OrderCreatedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—      â”‚
â”‚    â”‚                â”‚                â”‚ â•‘ STEP 3: Reserve Stock                  â•‘      â”‚
â”‚    â”‚                â”‚                â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•      â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ReserveStockCmdâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚      â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€StockReservedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚      â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—      â”‚
â”‚    â”‚                â”‚                â”‚ â•‘ SAGA COMPLETED âœ“                       â•‘      â”‚
â”‚    â”‚                â”‚                â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•      â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚â—€â”€â”€OrderResultâ”€â”€â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚â—€â”€â”€â”€200 OKâ”€â”€â”€â”€â”€â”€â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚    â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€PublishSagaCompletedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚
â”‚    â”‚                â”‚                â”‚               â”‚             â”‚             â”‚      â”‚
â”‚                                                                       NOTIFICATION      â”‚
â”‚                                                                       SERVICE          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Compensation Flow (Hata Durumu)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           COMPENSATION AKIÅI (HATA DURUMU)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                          â”‚
â”‚  Orchestrator      Customer       Order        Product       Payment   Notification     â”‚
â”‚       â”‚               â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—         â”‚
â”‚       â”‚ â•‘ STEP 1: Validate Customer  âœ“                                       â•‘         â”‚
â”‚       â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚       â”‚â”€â”€ValidateCmdâ”€â–¶â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚â—€â”€CustomerOKâ”€â”€â”€â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚               â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—         â”‚
â”‚       â”‚ â•‘ STEP 2: Create Order  âœ“                                            â•‘         â”‚
â”‚       â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚       â”‚â”€â”€â”€â”€â”€CreateOrderCmdâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚â—€â”€â”€â”€â”€OrderCreatedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚               â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—         â”‚
â”‚       â”‚ â•‘ STEP 3: Reserve Stock  âœ“                                           â•‘         â”‚
â”‚       â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ReserveStockCmdâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚           â”‚           â”‚
â”‚       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€StockReservedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚           â”‚           â”‚
â”‚       â”‚               â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—         â”‚
â”‚       â”‚ â•‘ STEP 4: Process Payment  âœ— FAILED!                                 â•‘         â”‚
â”‚       â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ProcessPaymentCmdâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚           â”‚           â”‚
â”‚       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€PaymentFailedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚           â”‚           â”‚
â”‚       â”‚               â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚ â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—        â”‚
â”‚       â”‚ â•‘             COMPENSATION BAÅLAT                                      â•‘        â”‚
â”‚       â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•        â”‚
â”‚       â”‚               â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—         â”‚
â”‚       â”‚ â•‘ COMP 3: Release Stock (Stok geri al)                               â•‘         â”‚
â”‚       â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ReleaseStockCmdâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚           â”‚           â”‚
â”‚       â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€StockReleasedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚           â”‚           â”‚
â”‚       â”‚               â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—         â”‚
â”‚       â”‚ â•‘ COMP 2: Cancel Order (SipariÅŸ iptal)                               â•‘         â”‚
â”‚       â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚       â”‚â”€â”€â”€â”€â”€CancelOrderCmdâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚â—€â”€â”€â”€â”€OrderCancelledâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚               â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—         â”‚
â”‚       â”‚ â•‘ SAGA FAILED - COMPENSATION DONE                                    â•‘         â”‚
â”‚       â”‚ â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•         â”‚
â”‚       â”‚               â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€PublishSagaFailedâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚           â”‚
â”‚       â”‚               â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â”‚       â”‚               â”‚             â”‚             â”‚             â”‚     ğŸ“§ Hata mail      â”‚
â”‚       â”‚               â”‚             â”‚             â”‚             â”‚           â”‚           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## SipariÅŸ Saga Ã–rneÄŸi

### Saga State Entity

```csharp
public class OrderSagaState
{
    public Guid SagaId { get; set; }
    public Guid OrderId { get; set; }
    public Guid CustomerId { get; set; }
    public string CustomerEmail { get; set; }
    public List<OrderItemDto> Items { get; set; }
    public decimal TotalAmount { get; set; }
    
    // Saga State
    public SagaStateEnum State { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? CompletedAt { get; set; }
    public string? FailureReason { get; set; }
    
    // Completed Steps (for compensation)
    public bool CustomerValidated { get; set; }
    public bool OrderCreated { get; set; }
    public bool StockReserved { get; set; }
    public bool PaymentProcessed { get; set; }
}

public enum SagaStateEnum
{
    Created,
    ValidatingCustomer,
    CreatingOrder,
    ReservingStock,
    ProcessingPayment,
    Completed,
    Compensating,
    Failed
}
```

### Message Contracts

```csharp
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMMANDS (OrkestratÃ¶r â†’ Servisler)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

public record ValidateCustomerCommand(
    Guid SagaId,
    Guid CustomerId,
    string ReplyTo);

public record CreateOrderCommand(
    Guid SagaId,
    Guid CustomerId,
    List<OrderItemDto> Items,
    string ReplyTo);

public record ReserveStockCommand(
    Guid SagaId,
    Guid OrderId,
    List<OrderItemDto> Items,
    string ReplyTo);

public record ProcessPaymentCommand(
    Guid SagaId,
    Guid OrderId,
    decimal Amount,
    string PaymentMethod,
    string ReplyTo);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPENSATION COMMANDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

public record CancelOrderCommand(
    Guid SagaId,
    Guid OrderId,
    string Reason);

public record ReleaseStockCommand(
    Guid SagaId,
    Guid OrderId,
    List<OrderItemDto> Items);

public record RefundPaymentCommand(
    Guid SagaId,
    Guid OrderId,
    decimal Amount);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REPLIES (Servisler â†’ OrkestratÃ¶r)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

public record CustomerValidatedReply(
    Guid SagaId,
    bool IsValid,
    string? ValidationError,
    string CustomerEmail);

public record OrderCreatedReply(
    Guid SagaId,
    bool Success,
    Guid? OrderId,
    string? Error);

public record StockReservedReply(
    Guid SagaId,
    bool Success,
    string? Error);

public record PaymentProcessedReply(
    Guid SagaId,
    bool Success,
    string? TransactionId,
    string? Error);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENTS (Notification iÃ§in)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

public record SagaCompletedEvent(
    Guid SagaId,
    Guid OrderId,
    Guid CustomerId,
    string CustomerEmail,
    decimal TotalAmount);

public record SagaFailedEvent(
    Guid SagaId,
    Guid CustomerId,
    string CustomerEmail,
    string FailureReason);
```

---

## Implementasyon

### 1. Saga Orchestrator (Azure Function)

```csharp
public class OrderSagaOrchestrator
{
    private readonly ServiceBusClient _serviceBus;
    private readonly ISagaStateStore _stateStore;
    private readonly ILogger<OrderSagaOrchestrator> _logger;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SAGA BAÅLAT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    [Function("StartOrderSaga")]
    public async Task StartOrderSaga(
        [HttpTrigger(AuthorizationLevel.Function, "post", Route = "saga/order")] 
        HttpRequest req)
    {
        var request = await JsonSerializer.DeserializeAsync<CreateOrderSagaRequest>(req.Body);
        
        // Saga state oluÅŸtur
        var saga = new OrderSagaState
        {
            SagaId = Guid.NewGuid(),
            CustomerId = request.CustomerId,
            Items = request.Items,
            TotalAmount = request.Items.Sum(i => i.Quantity * i.UnitPrice),
            State = SagaStateEnum.Created,
            CreatedAt = DateTime.UtcNow
        };
        
        await _stateStore.SaveAsync(saga);
        
        // Ä°lk adÄ±mÄ± baÅŸlat: Customer Validation
        await SendCommandAsync("validate-customer-queue", new ValidateCustomerCommand(
            saga.SagaId,
            saga.CustomerId,
            "saga-reply-queue"));
        
        saga.State = SagaStateEnum.ValidatingCustomer;
        await _stateStore.SaveAsync(saga);
        
        _logger.LogInformation("Order Saga started: {SagaId}", saga.SagaId);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REPLY HANDLER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    [Function("HandleSagaReply")]
    public async Task HandleSagaReply(
        [ServiceBusTrigger("saga-reply-queue")] ServiceBusReceivedMessage message)
    {
        var messageType = message.ApplicationProperties["MessageType"]?.ToString();
        
        switch (messageType)
        {
            case nameof(CustomerValidatedReply):
                await HandleCustomerValidated(
                    JsonSerializer.Deserialize<CustomerValidatedReply>(message.Body));
                break;
                
            case nameof(OrderCreatedReply):
                await HandleOrderCreated(
                    JsonSerializer.Deserialize<OrderCreatedReply>(message.Body));
                break;
                
            case nameof(StockReservedReply):
                await HandleStockReserved(
                    JsonSerializer.Deserialize<StockReservedReply>(message.Body));
                break;
                
            case nameof(PaymentProcessedReply):
                await HandlePaymentProcessed(
                    JsonSerializer.Deserialize<PaymentProcessedReply>(message.Body));
                break;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STEP HANDLERS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    private async Task HandleCustomerValidated(CustomerValidatedReply reply)
    {
        var saga = await _stateStore.GetAsync(reply.SagaId);
        
        if (reply.IsValid)
        {
            saga.CustomerValidated = true;
            saga.CustomerEmail = reply.CustomerEmail;
            saga.State = SagaStateEnum.CreatingOrder;
            
            // Sonraki adÄ±m: Create Order
            await SendCommandAsync("create-order-queue", new CreateOrderCommand(
                saga.SagaId,
                saga.CustomerId,
                saga.Items,
                "saga-reply-queue"));
        }
        else
        {
            // Saga baÅŸarÄ±sÄ±z (compensation gerekli deÄŸil, ilk adÄ±m)
            saga.State = SagaStateEnum.Failed;
            saga.FailureReason = reply.ValidationError;
            
            await PublishSagaFailed(saga);
        }
        
        await _stateStore.SaveAsync(saga);
    }
    
    private async Task HandleOrderCreated(OrderCreatedReply reply)
    {
        var saga = await _stateStore.GetAsync(reply.SagaId);
        
        if (reply.Success)
        {
            saga.OrderCreated = true;
            saga.OrderId = reply.OrderId!.Value;
            saga.State = SagaStateEnum.ReservingStock;
            
            // Sonraki adÄ±m: Reserve Stock
            await SendCommandAsync("reserve-stock-queue", new ReserveStockCommand(
                saga.SagaId,
                saga.OrderId,
                saga.Items,
                "saga-reply-queue"));
        }
        else
        {
            // Compensation baÅŸlat
            saga.State = SagaStateEnum.Compensating;
            saga.FailureReason = reply.Error;
            
            await StartCompensation(saga);
        }
        
        await _stateStore.SaveAsync(saga);
    }
    
    private async Task HandleStockReserved(StockReservedReply reply)
    {
        var saga = await _stateStore.GetAsync(reply.SagaId);
        
        if (reply.Success)
        {
            saga.StockReserved = true;
            
            // Son adÄ±m tamamlandÄ± - Saga baÅŸarÄ±lÄ±!
            saga.State = SagaStateEnum.Completed;
            saga.CompletedAt = DateTime.UtcNow;
            
            await PublishSagaCompleted(saga);
        }
        else
        {
            saga.State = SagaStateEnum.Compensating;
            saga.FailureReason = reply.Error;
            
            await StartCompensation(saga);
        }
        
        await _stateStore.SaveAsync(saga);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPENSATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    private async Task StartCompensation(OrderSagaState saga)
    {
        _logger.LogWarning("Starting compensation for saga: {SagaId}", saga.SagaId);
        
        // Geri alma sÄ±rasÄ±: Son adÄ±mdan baÅŸa doÄŸru
        
        if (saga.StockReserved)
        {
            await SendCommandAsync("release-stock-queue", new ReleaseStockCommand(
                saga.SagaId,
                saga.OrderId,
                saga.Items));
        }
        
        if (saga.OrderCreated)
        {
            await SendCommandAsync("cancel-order-queue", new CancelOrderCommand(
                saga.SagaId,
                saga.OrderId,
                saga.FailureReason));
        }
        
        // Compensation tamamlandÄ±
        saga.State = SagaStateEnum.Failed;
        await _stateStore.SaveAsync(saga);
        
        await PublishSagaFailed(saga);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EVENT PUBLISHING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    private async Task PublishSagaCompleted(OrderSagaState saga)
    {
        await SendToTopicAsync("saga-events-topic", new SagaCompletedEvent(
            saga.SagaId,
            saga.OrderId,
            saga.CustomerId,
            saga.CustomerEmail,
            saga.TotalAmount));
    }
    
    private async Task PublishSagaFailed(OrderSagaState saga)
    {
        await SendToTopicAsync("saga-events-topic", new SagaFailedEvent(
            saga.SagaId,
            saga.CustomerId,
            saga.CustomerEmail,
            saga.FailureReason));
    }
}
```

### 2. Customer Service Handler

```csharp
public class CustomerSagaHandler
{
    private readonly ICustomerRepository _customerRepository;
    private readonly ServiceBusSender _replySender;
    
    [Function("HandleValidateCustomer")]
    public async Task HandleValidateCustomer(
        [ServiceBusTrigger("validate-customer-queue")] ValidateCustomerCommand command)
    {
        CustomerValidatedReply reply;
        
        try
        {
            var customer = await _customerRepository.GetByIdAsync(command.CustomerId);
            
            if (customer == null)
            {
                reply = new CustomerValidatedReply(
                    command.SagaId,
                    IsValid: false,
                    ValidationError: "Customer not found",
                    CustomerEmail: null);
            }
            else if (customer.Status != CustomerStatus.Active)
            {
                reply = new CustomerValidatedReply(
                    command.SagaId,
                    IsValid: false,
                    ValidationError: "Customer is not active",
                    CustomerEmail: null);
            }
            else
            {
                reply = new CustomerValidatedReply(
                    command.SagaId,
                    IsValid: true,
                    ValidationError: null,
                    CustomerEmail: customer.Email);
            }
        }
        catch (Exception ex)
        {
            reply = new CustomerValidatedReply(
                command.SagaId,
                IsValid: false,
                ValidationError: ex.Message,
                CustomerEmail: null);
        }
        
        await SendReplyAsync(command.ReplyTo, reply);
    }
}
```

### 3. Product Service Handler

```csharp
public class ProductSagaHandler
{
    private readonly IProductRepository _productRepository;
    
    [Function("HandleReserveStock")]
    public async Task HandleReserveStock(
        [ServiceBusTrigger("reserve-stock-queue")] ReserveStockCommand command)
    {
        StockReservedReply reply;
        
        try
        {
            foreach (var item in command.Items)
            {
                var product = await _productRepository.GetByIdAsync(item.ProductId);
                
                if (product == null || product.StockQuantity < item.Quantity)
                {
                    reply = new StockReservedReply(
                        command.SagaId,
                        Success: false,
                        Error: $"Insufficient stock for product: {item.ProductId}");
                    
                    await SendReplyAsync(command.ReplyTo, reply);
                    return;
                }
            }
            
            // Stok rezerve et
            foreach (var item in command.Items)
            {
                await _productRepository.ReserveStockAsync(item.ProductId, item.Quantity);
            }
            
            reply = new StockReservedReply(command.SagaId, Success: true, Error: null);
        }
        catch (Exception ex)
        {
            reply = new StockReservedReply(command.SagaId, Success: false, Error: ex.Message);
        }
        
        await SendReplyAsync(command.ReplyTo, reply);
    }
    
    [Function("HandleReleaseStock")]
    public async Task HandleReleaseStock(
        [ServiceBusTrigger("release-stock-queue")] ReleaseStockCommand command)
    {
        // Compensation: Stoku geri ver
        foreach (var item in command.Items)
        {
            await _productRepository.ReleaseStockAsync(item.ProductId, item.Quantity);
        }
    }
}
```

### 4. Notification Service Handler

```csharp
public class NotificationSagaHandler
{
    private readonly IEmailService _emailService;
    
    [Function("HandleSagaCompleted")]
    public async Task HandleSagaCompleted(
        [ServiceBusTrigger("saga-events-topic", "saga-completed-subscription")] 
        SagaCompletedEvent @event)
    {
        await _emailService.SendAsync(new EmailRequest
        {
            To = @event.CustomerEmail,
            Subject = $"SipariÅŸiniz OnaylandÄ± - #{@event.OrderId}",
            Template = "order-confirmed",
            Data = new
            {
                OrderId = @event.OrderId,
                TotalAmount = @event.TotalAmount
            }
        });
    }
    
    [Function("HandleSagaFailed")]
    public async Task HandleSagaFailed(
        [ServiceBusTrigger("saga-events-topic", "saga-failed-subscription")] 
        SagaFailedEvent @event)
    {
        await _emailService.SendAsync(new EmailRequest
        {
            To = @event.CustomerEmail,
            Subject = "SipariÅŸiniz Ä°ÅŸlenemedi",
            Template = "order-failed",
            Data = new
            {
                Reason = @event.FailureReason
            }
        });
    }
}
```

---

## Docker Compose YapÄ±landÄ±rmasÄ±

```yaml
# docker-compose.yml

services:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # AZURE SERVICE BUS EMULATOR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  servicebus-emulator:
    image: mcr.microsoft.com/azure-messaging/servicebus-emulator:latest
    container_name: servicebus-emulator
    ports:
      - "5672:5672"   # AMQP
    volumes:
      - ./servicebus-config.json:/ServiceBus_Emulator/ConfigFiles/Config.json
    networks:
      - saga-network
    environment:
      - ACCEPT_EULA=Y
      - SERVICEBUS_EMULATOR_LOG_LEVEL=Warning

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # SAGA ORCHESTRATOR
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  saga-orchestrator:
    build:
      context: ./src/services/Saga
      dockerfile: Dockerfile
    container_name: saga-orchestrator
    ports:
      - "7072:80"
    environment:
      - AzureWebJobsStorage=UseDevelopmentStorage=true
      - ServiceBusConnection=Endpoint=sb://localhost;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=SAS_KEY
    depends_on:
      - servicebus-emulator
      - azurite
    networks:
      - saga-network

  # Mevcut servisler...
  sqlserver:
    # ...
    
  cosmosdb:
    # ...
    
  azurite:
    # ...
```

### Service Bus Config (servicebus-config.json)

```json
{
  "UserConfig": {
    "Namespaces": [
      {
        "Name": "saga-namespace",
        "Queues": [
          { "Name": "validate-customer-queue" },
          { "Name": "create-order-queue" },
          { "Name": "reserve-stock-queue" },
          { "Name": "process-payment-queue" },
          { "Name": "cancel-order-queue" },
          { "Name": "release-stock-queue" },
          { "Name": "saga-reply-queue" }
        ],
        "Topics": [
          {
            "Name": "saga-events-topic",
            "Subscriptions": [
              { "Name": "saga-completed-subscription" },
              { "Name": "saga-failed-subscription" },
              { "Name": "audit-subscription" }
            ]
          }
        ]
      }
    ]
  }
}
```

---

## Test ve DoÄŸrulama

### Test SenaryolarÄ±

```http
### 1. BaÅŸarÄ±lÄ± SipariÅŸ
POST http://localhost:7072/api/saga/order
Content-Type: application/json

{
  "customerId": "valid-customer-id",
  "items": [
    { "productId": 1, "quantity": 2, "unitPrice": 100 },
    { "productId": 2, "quantity": 1, "unitPrice": 50 }
  ]
}

### Beklenen SonuÃ§:
# 1. Customer validated âœ“
# 2. Order created âœ“
# 3. Stock reserved âœ“
# 4. Saga completed âœ“
# 5. Email gÃ¶nderildi âœ“


### 2. GeÃ§ersiz MÃ¼ÅŸteri
POST http://localhost:7072/api/saga/order
Content-Type: application/json

{
  "customerId": "invalid-customer-id",
  "items": [...]
}

### Beklenen SonuÃ§:
# 1. Customer validation failed âœ—
# 2. Saga failed (no compensation needed)
# 3. Error email gÃ¶nderildi


### 3. Yetersiz Stok
POST http://localhost:7072/api/saga/order
Content-Type: application/json

{
  "customerId": "valid-customer-id",
  "items": [
    { "productId": 1, "quantity": 9999, "unitPrice": 100 }  # Ã‡ok fazla
  ]
}

### Beklenen SonuÃ§:
# 1. Customer validated âœ“
# 2. Order created âœ“
# 3. Stock reservation failed âœ—
# 4. Compensation: Cancel order
# 5. Saga failed
# 6. Error email gÃ¶nderildi
```

---

## Ã–zet

Bu dokÃ¼mantasyon, Azure Service Bus kullanarak Saga Orchestration pattern'inin nasÄ±l uygulanacaÄŸÄ±nÄ± kapsamlÄ± olarak aÃ§Ä±klamaktadÄ±r:

| BileÅŸen | AÃ§Ä±klama |
|---------|----------|
| **Saga Orchestrator** | Merkezi koordinatÃ¶r, state machine yÃ¶netimi |
| **Command Queues** | OrkestratÃ¶r â†’ Servisler (point-to-point) |
| **Reply Queue** | Servisler â†’ OrkestratÃ¶r (yanÄ±tlar) |
| **Event Topics** | Saga tamamlandÄ±/baÅŸarÄ±sÄ±z â†’ Notification |
| **Compensation** | Hata durumunda geri alma mekanizmasÄ± |
| **State Store** | Saga durumunun kalÄ±cÄ± saklanmasÄ± |

### Sonraki AdÄ±mlar

1. âœ… Azure Service Bus Emulator kurulumu
2. âœ… Saga Orchestrator Azure Function projesi
3. âœ… Servis handler'larÄ±
4. âœ… Notification entegrasyonu
5. âœ… End-to-end testler
